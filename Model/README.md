# ğŸ¤– Model â€” Alert Account Prediction Model  
**PU-Learning + RankStack + LightGBM**

This folder contains the **training and inference pipeline** of the competition model.  
It consumes features generated by `Preprocess/feature_engineering_timefix.py` and  
outputs submit-ready prediction files under `../submit/`.

æ­¤è³‡æ–™å¤¾è² è²¬ **æ¨¡å‹è¨“ç·´èˆ‡æ¨è«–æµç¨‹**ã€‚  
æœƒè®€å– `Preprocess/feature_engineering_timefix.py` ç”¢ç”Ÿçš„ç‰¹å¾µæª”ï¼Œ  
ä¸¦åœ¨ `../submit/` è³‡æ–™å¤¾ä¸­è¼¸å‡ºå¯ç›´æ¥ä¸Šå‚³çš„é æ¸¬çµæœã€‚

---

## ğŸ“ Files æª”æ¡ˆèªªæ˜

### `model.py`

Main script for **training the model and generating predictions**.

æ­¤æª”æ¡ˆç‚º**ä¸»è¦æ¨¡å‹ç¨‹å¼**ï¼Œè² è²¬è¨“ç·´èˆ‡ç”¢ç”Ÿé æ¸¬çµæœã€‚

It performs the following steps:

1. **Load feature files from `../data/`**  
   å¾ `../data/` è®€å–ç‰¹å¾µæª”ï¼š
   - `features_train.csv`
   - `features_pred.csv`
   - `features_meta.json`

2. **Resolve feature columns**  
   - Reads `feature_cols` from `features_meta.json`.  
   - If missing, automatically infers feature columns from `features_train.csv`  
     (excluding `acct`, `label`, `is_unlabeled`).  
   å…ˆå¾ `features_meta.json` å–å¾— `feature_cols`ï¼Œ  
   è‹¥ä¸å­˜åœ¨å‰‡å¾ `features_train.csv` è‡ªå‹•åµæ¸¬ï¼ˆæ’é™¤ `acct`, `label`, `is_unlabeled`ï¼‰ã€‚

3. **Prepare training / prediction matrices**  
   - Training matrix `X`, labels `y` (`label`), unlabeled flag `u` (`is_unlabeled`).  
   - Prediction matrix `X_te`, account IDs `acct_te`.  
   æº–å‚™è¨“ç·´èˆ‡é æ¸¬ç”¨çš„ç‰¹å¾µçŸ©é™£èˆ‡æ¨™ç±¤ã€‚

4. **Train PU-Learning LightGBM classifier (meta model)**  
   - Uses `GAMMA_FIXED` as the weight for unlabeled samples.  
   - Stratified K-Fold (`N_FOLDS`) with OOF predictions.  
   ä½¿ç”¨ PU-Learning æ€ç¶­è¨“ç·´ LightGBMï¼Œå°æœªæ¨™æ¨£æœ¬çµ¦ä¸åŒæ¬Šé‡ä¸¦åš K æŠ˜äº¤å‰é©—è­‰ã€‚

5. **Apply Platt scaling (Logistic Regression)**  
   - Fits a logistic regression model on OOF scores vs labels.  
   - Produces calibrated meta probabilities `meta_cal`.  
   ä½¿ç”¨ Logistic Regression å° OOF æ©Ÿç‡åšæ ¡æº–ï¼Œå¾—åˆ°è¼ƒç©©å®šçš„ `meta_cal` æ©Ÿç‡ã€‚

6. **Train middle-band Ranker (LightGBM ensemble)**  
   - Only samples with OOF scores in a specified quantile band (`BAND`) are used.  
   - Multiple seeds in `RANKER_SEEDS` are used for bagging.  
   åœ¨ OOF åˆ†æ•¸çš„ä¸­æ®µå€é–“è¨“ç·´ Rankerï¼Œä¸¦ç”¨å¤šå€‹éš¨æ©Ÿç¨®å­åš baggingã€‚

7. **Score fusion (RankStack)**  
   - Combines calibrated meta score and ranker score:  
     ```python
     final_score = ALPHA * meta_cal + (1 - ALPHA) * rank_score
     ```  
   å°‡ meta æ¨¡å‹èˆ‡ Ranker æ¨¡å‹çš„åˆ†æ•¸ç·šæ€§èåˆï¼Œå¾—åˆ°æœ€çµ‚åˆ†æ•¸ã€‚

8. **Top-K selection & output**  
   - Derives target rate from `ACC0_PUBLIC` as:  
     ```python
     RATE = 1.0 - ACC0_PUBLIC
     ```  
   - Computes K based on RATE and selects top-K accounts by `final_score`.  
   - Outputs:
     - `../submit/submit_stack_topk.csv`  
       - Columns: `acct`, `predict` (0/1)
     - `../submit/acct_predict_out_stack.csv`  
       - Columns: `acct`, `final_score`, `meta_cal`, `rank_score`  

   æ ¹æ“š Public ACC0 æ¨ä¼°é™½æ€§æ¯”ä¾‹ï¼Œæ±ºå®šè¦å–å‰ K åå¸³è™Ÿï¼Œä¸¦è¼¸å‡ºæäº¤æª”èˆ‡åˆ†æ•¸æª”ã€‚

---

## â–¶ï¸ How to Run åŸ·è¡Œæ–¹å¼

### âœ… Run model only (features already exist)  
åƒ…åŸ·è¡Œæ¨¡å‹ï¼ˆå‡è¨­ `data/` å·²æœ‰ç‰¹å¾µæª”ï¼‰ï¼š

```bash
python -m Model.model
